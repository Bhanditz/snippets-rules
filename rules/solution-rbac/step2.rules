// [START rbac_step_2]
service cloud.firestore {
   match /databases/{database}/documents {
     match /stories/{story} {
        function isSignedIn() {
          return request.auth != null;
        }

        function getRole() {
          // Read from the "roles" map in the story document.
          return resource.data.roles[request.auth.uid];
        }

        function isOneOfRoles(array) {
          // Determine if the user is one of an array of roles
          return isSignedIn() && (getRole() in array);
        }

        function isValidNewStory() {
          // Valid if story does not exist and the new story has the correct owner.
          return resource.data == null
            && request.resource.data.roles[request.auth.uid] == 'owner';
        }

        // Owners can read, write, and delete stories
        allow write: if isValidNewStory() || isOneOfRoles(['owner']);

         match /comments/{comment} {
            // [START_EXCLUDE]
            allow read, write: if false;
            // [END_EXCLUDE]
         }
     }
   }
}
// [END rbac_step_2]
